---
documentclass: article
fontsize: 12pt
date: "`r Sys.Date()`"
output: 
  bookdown::pdf_document2: 
    toc: false
    latex_engine: xelatex
    fig_caption: yes
    includes:
      in_header: preamble.sty
      before_body: titlepage.sty
bibliography: references.bib  
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(haven) # to read SAS files
library(kableExtra)
library(qwraps2)
library(rprojroot)
library(patchwork)
library(psych)
library(gtools)
library(geepack)
library(gee)

knitr::opts_chunk$set(echo = TRUE)
```
# Abstract {-}

# Introduction and data exploration
```{r load, include=FALSE, message=FALSE, warning=FALSE}
data <- read_sas(find_root_file("data/hearing500lr.sas7bdat", 
     criterion = has_file("LDA.Rproj"))) %>%
  mutate(side = as.factor(side),
         id = as.factor(id),
         age_measurement = age + TIME,
         age_discrete = cut(age,
                            breaks = c(0,30,50,70,100),
                            labels = c("<30", "30-50", "50-70",">70")),
         learning = 1*(TIME == 0))
#data %>%group_by(id) %>%summarize(diff = max(age_start) - min(age_start)) age_start should be the same all the time but there are huge differences. How is this possible?
summary_data_id <- data %>%
  group_by(id) %>%
  summarize(age = min(age),
            followup = max(TIME),
            nb_visits_left = sum(side == "left"),
            nb_visits_right = sum(side == "right"),
            nb_visits = n_distinct(TIME),
            nb_measurements = n(),
            visits_per_year = ifelse(followup == 0,
                                     NA,
                                     nb_visits / followup))
#sum(summary_data_id$nb_visits_left != summary_data_id$nb_visits_right)#there are 112 people who weren't measure an equal amount of times on the left and right side
summary_data_visit <- data %>%
  group_by(id, TIME) %>%
  summarize(age = min(age) + max(TIME),
            left = sum(side == "left") > 0,
            right = sum(side == "right") > 0)

#correlations
d <- data %>%
  mutate(id = as.numeric(id),
         left = 1*(side == "left")) %>%
  dplyr::select(id, y, left, age_measurement)
```

This report assesses hearing thresholds for a sample of `r nlevels(data$id)` healthy male volunteers. The subjects were `r round(mean(summary_data_id$age))` years old on average at the start of the study and are followed for an average of `r round(mean(summary_data_id$followup), digits = 2)` years. The hearing threshold is measured, on average, every `r round(1/mean(summary_data_id$visits_per_year, na.rm = T), digits = 2)` years. Table \@ref(tab:demographics) describes the demographics in more detail. It can be seen that the data is highly unbalanced; there is a lot of variation in the time a volunteer is followed and in the number of times a volunteer's hearing threshold is measured. 
Normally, each ear is measured at each visit but this only happened in `r round(100*sum(summary_data_visit$left & summary_data_visit$right) /nrow(summary_data_visit), 2)`% of all visits. The left (right) ear was tested in `r round(100*sum(summary_data_visit$left) /nrow(summary_data_visit), 2)`% (`r round(100*sum(summary_data_visit$right) /nrow(summary_data_visit), 2)`%) of all visits.

Previous research on the hearing data of males in the Baltimore Longitudinal Study of Aging (BLSA) showed a change in hearing threshold for all age groups but especially the older population [@doi:10.1121/1.399731]. In contrast to our dataset, @doi:10.1121/1.412231 and @morrell1997construction consider females in their study. They similarly found a decrease in hearing sensitivity for all ages at 500Hz and included a quadratic function of age to predict the hearing threshold, as in @verbeke2001conditional. Additionally, a statistically significant learning effect from the first visit to subsequent visits was found [@morrell1997construction; @verbeke2001conditional]. @morrell1997construction observed that hearing levels are slightly poorer on average on the left compared to the right ear and that the variance in the hearing threshold is higher for people with a higher age.


Figure \@ref(fig:rawdata) shows the trends in the hearing threshold for all volunteers over time. These figures shows that many volunteers' hearing threshold over time have an erratic pattern meaning there is likely high variability **within subjects**. Additionally, variability **between subjects** is also high, especially for older volunteers.  


```{r demographics, echo=FALSE}
summary_data_id %>% 
  summarize(
    qwraps2::frmt(min(age)), 
    qwraps2::frmt(max(age)),
    qwraps2::frmt(median(age)), 
    qwraps2::mean_sd(age),
    qwraps2::frmt(min(followup)), 
    qwraps2::frmt(max(followup)), 
    qwraps2::frmt(median(followup)),
    qwraps2::mean_sd(followup),
    qwraps2::frmt(min(nb_visits)), 
    qwraps2::frmt(max(nb_visits)), 
    qwraps2::frmt(median(nb_visits)),
    qwraps2::mean_sd(nb_visits)) %>%
  pivot_longer(cols = everything(),
               names_to = "var",
               values_to = "value") %>%
  mutate(var = rep(c("min","max", "median", "mean (sd)"), 3)) %>%
  kable("latex",
        caption = "Demographics for all respondents",
        col.names = NULL,
        booktabs = TRUE,
        position = "!b",
        escape = FALSE) %>%
  pack_rows("Age at the beginning of the study", 1, 4) %>%
  pack_rows("Years of follow-up", 5, 8) %>%
  pack_rows("Number of visits", 9, 12)
```


```{r rawdata, echo=FALSE, fig.cap="Hearing threshold over time, divided by left and right ear and by age group at the start of the study", fig.height=5}
agedistribution <- data %>%
  group_by(age_discrete) %>%
  summarize(nb = n_distinct(id)) %>%
  ungroup() %>%
  mutate(label = sprintf("%s, (n = %d)", age_discrete, nb))
lbl_age <- agedistribution$label
names(lbl_age) <- agedistribution$age_discrete

data %>% 
  mutate() %>%
  ggplot() +
  geom_line(aes(x = TIME, y = y,  group = id), alpha = 0.3) +
  facet_grid(cols = vars(side),
             rows = vars(age_discrete),
             labeller = labeller(age_discrete = lbl_age)) +
  theme_bw() +
  ylab("Hearing threshold (Db)") 
```

```{r rawdata2, echo=FALSE, eval = FALSE, fig.cap= "Hearing threshold over time, divided by left and right ear.", fig.height=5}
eardistribution <- data %>%
  group_by(side) %>%
  summarize(nb = n_distinct(id)) %>%
  ungroup() %>%
  mutate(label = sprintf("%s, (n = %d)", side, nb))
lbl_side <- eardistribution$label
names(lbl_side) <- eardistribution$side

data %>% 
  mutate() %>%
  ggplot() +
  geom_line(aes(x = age_measurement, y = y,  group = id), alpha = 0.3) +
  facet_grid(rows = vars(side),
             labeller = labeller(side = lbl_side)) +
  theme_bw() +
  ylab("Hearing threshold (Db)") +
  xlab("Age at the time of the measurement")
```

## Mean, variance and correlation structure

Figure \@ref(fig:rawdata3) shows the mean and 95% confidence interval for the hearing threshold (dB) for different age groups. The thresholds for the age groups are chosen such that each group is approximately the same size (between 141 and 149 measurements in each group). The graph shows that the variance increases with age and there doesn't seem to be a significant difference, on average, between left and right ears.

```{r rawdata3, echo=FALSE, message = FALSE, fig.cap= "Hearing threshold over time, divided by left and right ear. The numbers in the bottom show the number of measurements that were taken.", fig.width = 5, fig.height=4}
#same number of measurements 
agediscrete <- data %>% 
  mutate(
    #age = cut(data$age_measurement, n = 15)
    age = cut_number(data$age_measurement, n = 15)) %>%
  group_by(side, age) %>%
  summarize(mean = mean(y),
            sd = sqrt(var(y)),
            n = n()) %>%
  ungroup() %>%
  mutate(error = qnorm(0.975)*sd/sqrt(n))#95percent conf intervals
  
p <- agediscrete %>% 
  ggplot() +
  geom_pointrange(aes(x = age, y = mean, color = side, group = side, 
                    ymin = mean - error, ymax = mean + error), 
                  position = position_dodge(width = 0.5), alpha = 1) +
  geom_text(aes(x = age, y = 0, label = n, color = side),
            position = position_dodge(width = 1), size = 2) +
  theme_bw() +
  ylab("Hearing threshold (Db), \nmean and 95% CI") +
  xlab("Age at the time of the measurement") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
        legend.position = "bottom")

#same range intervals
# agediscrete <- data %>% 
#   mutate(
#     age = cut_interval(data$age_measurement, n = 15)) %>%
#     #age = cut_number(data$age_measurement, n = 15)) %>%
#   group_by(side, age) %>%
#   summarize(mean = mean(y),
#             sd = sqrt(var(y)),
#             n = n()) %>%
#   ungroup() %>%
#   mutate(error = qnorm(0.975)*sd/sqrt(n))#95percent conf intervals
#   
# q <- agediscrete %>% 
#   ggplot() +
#   geom_pointrange(aes(x = age, y = mean, color = side, group = side, 
#                     ymin = mean - error, ymax = mean + error), 
#                   position = position_dodge(width = 0.5), alpha = 1) +
#   geom_text(aes(x = age, y = 0, label = n, color = side),
#             position = position_dodge(width = 1), size = 2) +
#   theme_bw() +
#   ylab("Hearing threshold (Db), mean and 95% CI") +
#   xlab("Age at the time of the measurement") + 
#   theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
#plot <- p / q & theme(legend.position = "bottom") 
#plot + plot_layout(guides = "collect")
p
```

Figure \@ref(fig:discretetime1) shows Loess smoothing curves by age category and side of the ear. The trend in the average is slightly increasing for most groups. For the oldest group, there is a more pronounced increase in the hearing threshold. Additionally, the estimated standard errors around the mean are larger as time increases, likely due to dropout. Based on the estimated averages from \@ref(fig:discretetime1), squared residuals can be calculated. Figure \@ref(fig:discretetime2) shows the Loess smoothed variance function for each group. Overall, the variance seems quite constant over time and it is higher for older subjects. The downward trend at time $>15$ for the oldest age group can possibly not be trusted due to limited data.

```{r discretetime1, echo=FALSE, message = FALSE, fig.cap= "Loess smoothing on the hearing threshold since start of the study, divided by left and right ear and age group at the start of the study.", fig.width = 5, fig.height=5}
data_discretetime <- data %>%
  mutate(timediscrete = floor(TIME)) %>% #we round everything down)
  group_by(id, side, age_discrete, timediscrete) %>%
  summarize(y = mean(y)) %>%
  ungroup() %>% 
  mutate(age_discrete = factor(as.factor(age_discrete), 
                               levels = names(lbl_age)))

p <- data_discretetime %>%
  ggplot() +
  geom_jitter(aes(x = timediscrete, y = y), alpha = 0.1, fill = "grey") +
  stat_smooth(aes(x = timediscrete, y = y), method =  "loess",
              fill = "blue", alpha = 0.2) +
  facet_grid(cols = vars(side),
             rows = vars(age_discrete),
             labeller = labeller(age_discrete = lbl_age)) +
  theme_bw() +
  ylab("Hearing threshold (Db)") +
  xlab("TIME")
p
```

```{r discretetime2, echo=FALSE, message = FALSE, fig.cap= "Loess smoothed variance in the hearing threshold since start of the study, divided by left and right ear and age group at the start of the study.", fig.width = 5, fig.height=5, warning = FALSE}
gridloess <- expand_grid(side = unique(data_discretetime$side), 
                    age_discrete = unique(data_discretetime$age_discrete)) %>%
  mutate(side = as.character(side),
         age_discrete = as.character(age_discrete))
l <- lapply(X = 1:nrow(gridloess), 
            FUN = function(x){
              l <- loess(y ~ timediscrete, 
                         subset = 
                           (side == unlist(gridloess[x,1]) & 
                              age_discrete == unlist(gridloess[x,2])), 
                         data = data_discretetime, method = "loess")
              
              return(data.frame(timediscrete = 0:22,
                                prediction = predict(l, 
                                                     data.frame(
                                                       timediscrete = 0:22)),
                                age_discrete = gridloess[x, 2],
                                side = gridloess[x, 1]))
            }) 
l <- do.call("rbind", l)

data_discretetime <- data_discretetime %>%
  left_join(l) %>%
  mutate(sqrd_resid = (y - prediction)^2,
         age_discrete = factor(as.factor(age_discrete), 
                               levels = names(lbl_age)))


p <- data_discretetime %>% 
  ggplot() +
  geom_jitter(aes(x = timediscrete, y = sqrd_resid), alpha = 0.1, 
              fill = "grey") +
  stat_smooth(aes(x = timediscrete, y = sqrd_resid), method =  "loess",
              fill = "blue", alpha = 0.2) +
  facet_grid(cols = vars(side),
             rows = vars(age_discrete),
             labeller = labeller(age_discrete = lbl_age)) +
  theme_bw() +
  ylab("Squared residual") +
  xlab("TIME") +
  ylim(0,250)
p
```



```{r , echo=FALSE, include=TRUE,  warning=FALSE, message=FALSE}
stats <- statsBy(d, group = c("id"), cors = FALSE, cor = "cov", 
        method = "pearson", use = "pairwise", poly = FALSE,
        na.rm = TRUE, alpha = .05)
morethan1 <- d %>% group_by(id, left) %>% summarize(n = n()) %>% ungroup() %>%
  group_by(id) %>% summarize(n=min(n)) %>%
  right_join(d) %>% filter(n > 1) %>% dplyr::select(-n)#only keep id's that have more than 1 measurement both on left and right ear
stats_gt1 <- statsBy(morethan1, group = c("id"), cors = TRUE, cor = "cov", 
        method = "pearson", use = "pairwise", poly = FALSE,
        na.rm = TRUE, alpha = .05)
#pull the correlations between y and age within each group
cov_within_age <- sapply(X = 1:length(stats_gt1$r), 
                     FUN = function(x) unlist(stats_gt1$r[x])[3])
cov_within_left <- sapply(X = 1:length(stats_gt1$r), 
                     FUN = function(x) unlist(stats_gt1$r[x])[2])
var_y <- sapply(X = 1:length(stats_gt1$r), 
                FUN = function(x) unlist(stats_gt1$r[x])[1])
var_age <- sapply(X = 1:length(stats_gt1$r), 
                FUN = function(x) unlist(stats_gt1$r[x])[9])
var_left <- sapply(X = 1:length(stats_gt1$r), 
                FUN = function(x) unlist(stats_gt1$r[x])[5])
correlations_within <- data.frame(cov_within_age = cov_within_age,
                                  cov_within_left = cov_within_left,
                                  var_y = var_y,
                                  var_age = var_age,
                                  var_left = var_left) %>%
  mutate(cor_within_age = cov_within_age / (sqrt(var_y)*sqrt(var_age)),
         cor_within_left = cov_within_left / (sqrt(var_y)*sqrt(var_left)))
#print(stats, short = FALSE)
meanstructure <- data.frame(stats_gt1$mean)
```
The data has a hierarchical (grouped) structure since each individual ($id$) is measured several times over the years. Some basic descriptive statistics were derived using the [*statsBy*](https://www.rdocumentation.org/packages/psych/versions/2.2.9/topics/statsBy) function from the psych package. The intraclass correlation (percentage of variance due to groups) is `r unname(round(stats_gt1$ICC1['y'],2))` for the hearing threshold ($y$) and, as expected, very high (`r unname(round(stats_gt1$ICC1['age_measurement'],2))`) for age at the time of measurement. 

The total correlation between y and the age at the measurement, ignoring the hierarchical structure, is `r round(cor(morethan1)['age_measurement','y'],2)`. Following @marzban2013within and @mongomery2017montgomery, the correlation matrix for each subject that has at least 2 measurements for both ears is calculated, one can obtain within-group correlations and variances. Figure \@ref(fig:correlations) shows the histograms over all individuals for the correlation between the age at the measurement and y, and the variances for both age and y (though the variance in age is not very informative). The mean or median of all within-group correlations is often used as a measure of within-group correlation. The mean (`r round(mean(correlations_within$cor_within_age, na.rm = TRUE),2)`) and median (`r round(median(correlations_within$cor_within_age, na.rm = TRUE),2)`) of the within-group correlations are indicated in red and blue respectively on the graph. It can be seen that within-group correlation spans the entire range from -1 to 1, meaning that age has a strong positive relationship to the hearing threshold for some and a strong negative relationship for others. Age will be a good predictor for hearing threshold for some but not for others. Between-group correlation is obtained by averaging the age at measurement and the hearing threshold for each group (see scatterplot in Figure \@ref(fig:correlations)) and then computing the correlation across the groups, obtaining `r round(cor(meanstructure)['age_measurement','y'],2)`. 

Panel B in Figure \@ref(fig:correlations) shows that the correlation between the side of the ear that is measured and the hearing threshold ($y$) is high for some but small for most individuals. Panel C in Figure \@ref(fig:correlations) shows that the variance in the hearing threshold is usually less then 50 but can be very large for some individuals.


```{r correlations, echo=FALSE, include=TRUE,  warning=FALSE, message=FALSE, fig.cap="The mean is indicated in red, the median in blue", fig.width = 6, fig.height=6}
p1 <- ggplot() + geom_histogram(data = correlations_within, 
                                aes(x = cor_within_age)) + 
  theme_bw() + xlab('Within-group correlation y & age') +
  ylab('Number of groups') +
  geom_vline(aes(xintercept = mean(correlations_within$cor_within_age, 
                                   na.rm = TRUE)), 
             color = 'red') +
  geom_vline(aes(xintercept = median(correlations_within$cor_within_age,
                                     na.rm = TRUE)), 
             color = 'blue') 
p2 <- ggplot(correlations_within) + geom_histogram(aes(x = var_y)) + 
  theme_bw() + xlab("Variance in y") + ylab('Number of groups') + 
  geom_vline(aes(xintercept = mean(correlations_within$var_y, 
                                   na.rm = TRUE)), 
             color = 'red') +
  geom_vline(aes(xintercept = median(correlations_within$var_y, 
                                     na.rm = TRUE)), 
             color = 'blue') 
p3 <- ggplot() + geom_histogram(data = correlations_within, 
                                aes(x = cor_within_left)) + 
  theme_bw() + xlab('Within-group correlation y & left') +
  ylab('Number of groups') +
  geom_vline(aes(xintercept = mean(correlations_within$cor_within_left, 
                                   na.rm = TRUE)), 
             color = 'red') +
  geom_vline(aes(xintercept = median(correlations_within$cor_within_left, 
                                     na.rm = TRUE)), 
             color = 'blue') 
p4 <- ggplot(meanstructure) + geom_point(aes(y = y, x = age_measurement)) +
  xlab("mean age") + ylab("mean hearing threshold (dB)") + theme_bw() 
  
p1 + p3 + p2 + p4 + plot_annotation(tag_levels = 'A')
```



```{r variogram, echo=FALSE, include=TRUE,  warning=FALSE, message=FALSE, fig.cap="Semi-variogram", fig.width = 6, fig.height=4}
library(joineR)
if (!file.exists(find_root_file("data/vgm.RData", 
     criterion = has_file("LDA.Rproj")))) {
vgm  <- joineR::variogram(data_discretetime[1:2887,'id'], 
                          data_discretetime[1:2887,'timediscrete'], 
                          data_discretetime[1:2887,'y'])#full dataset takes very long to calculate
save(vgm, file = find_root_file("data", "vgm.RData", 
     criterion = has_file("LDA.Rproj")))
} else {
  load(find_root_file("data/vgm.RData", 
     criterion = has_file("LDA.Rproj")))
}
if (!file.exists(find_root_file("data/variogram.pdf", 
     criterion = has_file("LDA.Rproj")))){
  pdf(width = 6, height = 4, file = "data/variogram.pdf")
  plot(vgm, ylim = c(0,200))
  dev.off()
}
knitr::include_graphics("data/variogram.pdf")
```
Lastly, a semi-variogram is constructed using the [*joineR* package](https://rdrr.io/cran/joineR/). The total variance is estimated to be `r round(vgm$sigma2,2)`. Measurement error is approximately `r round(mean(vgm$svar[vgm$svar[,1]==0,2]),2)`, the serial correlation component is approximately `r round(mean(vgm$svar[vgm$svar[,1]==21,2]),2) - round(mean(vgm$svar[vgm$svar[,1]==0,2]),2)` and the between-subject variability is thus `r round(vgm$sigma2 - mean(vgm$svar[vgm$svar[,1]==21,2]),2)`.


# Methodology

In this section, we explore a couple of different methods to analyze the data. 
All analysis was carried out with the statistical software R. All scripts are freely available at [this git repository](https://github.com/raiisac/LDA).

## Summary statistics

One possibility to deal with the hierarchical structure of the data is to summarize the data and reduce the number of measurements per subject to one.

A simple paired-t test can check whether there is a significant difference between the left and right ear. For this test, the difference $\Delta^1_it$ is calculated between the hearing threshold of the left and right ear for each subject $i$ and at each time instance $t$ that both ears were measured (equation \@ref(eq:delta1)).

\begin{equation}
\Delta^1_{it} = Y_{ilt} - Y_{irt}
(\#eq:delta1)
\end{equation}

If the focus is on the change in hearing threshold over time, we can, for instance, calculate the average change in the hearing threshold for each subject $i$, $\Delta^2_i$ as in equation \@ref(eq:delta2) where $Y_{ijk}$ is the $k^{th}$ measurement for ear $j \in \{l,r\}$ of subject $i$ and $n_{ij}$ is the total number of measurements of ear $j$ of subject $i$.

\begin{equation}
\Delta^2_i = \frac{(Y_{iln_{il}} - Y_{il1} ) + (Y_{irn_{ir}} - Y_{ir1})}{2}
(\#eq:delta2)
\end{equation}

Alternatively, if the difference between the left and right ear is an important effect to analyse, equation \@ref(eq:delta3) shows an alternative with one summary measure for each ear $j$ of subject $i$ with at least two measurements over time. $n_{ij}$ is the total number of measurements of ear $j$ of subject $i$.

\begin{equation}
\Delta^3_{ij} = Y_{ijn_{ij}} - Y_{ij1} 
(\#eq:delta3)
\end{equation}

Equation \@ref(eq:delta2) and \@ref(eq:delta3) will allow us to see how the *evolution* of the hearing threshold differs for different age and side of the ear but will it not tell us anything about the *level* of the hearing threshold. To test whether the hearing threshold depends on age and side of the ear, equation \@ref(eq:delta4) introduces $\Delta^4_{ij}$ as the average measured hearing threshold for ear $j$ of subject $i$. $n_{ij}$ is the total number of measurements that were recorded for ear $j$ of subject $i$.

\begin{equation}
\Delta^4_{ij} = \frac{\sum_{t=1}^{t=n_{ij}} Y_{ijt}}{n_{ij}}
(\#eq:delta4)
\end{equation}

A first, obvious problem with this method is that it does not allow us to test all hypotheses of interest in one model. Additionally, a lot of information is lost:

- Only subjects with multiple measures on each ear are included in  the summary measure of  equation \@ref(eq:delta2)
- Only ears that have been measured more than once are included in the summary measures of equation \@ref(eq:delta3) 
- Only subjects that were measured on both ears at a certain time instance are included in the summary measures of equation \@ref(eq:delta1)
- While the summary measures of equation \@ref(eq:delta2) and \@ref(eq:delta3) can tell us something about the evolution in the long run because it focuses on the first and last measurement, all information on the trajectory between the first and last measurement is lost.
- Since the within-subject variability is rather large, relying on the first and last measurement as in equation \@ref(eq:delta2) and \@ref(eq:delta3) is risky.
- Previous literature found the hearing threshold was significantly higher for the first measurement (learning effect). Relying on the first measurement as in \@ref(eq:delta2) and \@ref(eq:delta3) may be worrisome.

To examine if the periodic shift in hearing capacity is affected by the patient's initial age and their time within the study, we examine their individual observed median absolute deviations (MAD) and their incremental shifts in hearing capability per year (SPY).

\begin{equation}
MAD_{ij} = MEDIAN(|Y_{ijk}-\overline{Y_{ij}}|)
\end{equation}

\begin{equation}
SPY_{ij} = \frac{Y_{ijk_{max}}-Y_{ij1}}{Trial Duration}
\end{equation}

The goal here is to see if patients of an older age, or patients with a longer study period, have larger degrees of variability in their hearing capacity. Examination of this relation could pose to provide insight into the nature of how hearing capability evolves over time. A positive relation between these metrics and a patients' starting age, in addition to their time spent in the study, would imply that hearing capabilities of older people have a more pronounced evolution compared to those of younger people. These variability measurements were taken in respect to both the left and right ears and then analyzed via an ANCOVA model. 

## Multivariate model

A multivariate model is constructed and we find the most parsimonious mean structure for it. Given the unbalanced data set, the [*gee*](https://cran.r-project.org/web/packages/gee/) and [*geepack*](https://cran.r-project.org/web/packages/geepack/) packages are used to conduct Generalized Estimating Equations. We will conduct these under the strict assumptions of normality. We will compare models using Quasi-Information Criterium (QIC), the RMSE of the fitted residuals, and `ANOVA\MANOVA` tests. After some model searching in order to select the most parsimonious mean structure we will take care of selecting the appropriate covariance structure. 

## Two-stage analysis

In a two-stage analysis, subject-specific intercepts and time effects are first estimated. In the second step, these subject-specific parameters are analysed and related to additional covariates such as the age or the side of the ear.


## Random-effects model

Lastly, a random-effects model is fit. This model is similar to the two-stage model but both stages are now combined in one model. We use the [*nlme*](https://cran.r-project.org/web/packages/nlme/) package in R to fit the models.

# Results

## Summary statistics

```{r Delta1, echo=FALSE, include=TRUE,  warning=FALSE, message=FALSE, fig.cap="Semi-variogram", fig.width = 6, fig.height=4}
data %>% group_by(id, TIME) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  filter(n == 2) %>%
  right_join(data) %>%
  pivot_wider(names_from = side, values_from = y) %>%
  mutate(diff = left - right) -> pairedt
paired <- t.test(x = pairedt$left, y = pairedt$right, paired = TRUE, 
                 alternative = "two.sided")
pairedmod <- lm(diff ~ age_measurement, data = pairedt)
pairedmod2 <- lm(diff ~ age_discrete, data = pairedt)
#summary(pairedmod)
#summary(pairedmod2)
```

First, a two-sided paired t-test is done, comparing the hearing threshold between the left and right ear. With a p-value of `r round(paired$p.value, 2)`, there doesn't seem to be a significant difference between the hearing threshold for the left and right ear. Simple linear regression models that relate the age (on a continuous or discrete scale) to $\Delta^1_{it}$ (equation \@ref(eq:delta1)) also did not find any significant effects.

```{r Delta2, echo=FALSE, include=TRUE,  warning=FALSE, message=FALSE}
data %>% group_by(id, side, age, age_discrete) %>%
  arrange(id, side, TIME) %>%
  summarize(n = n(),
            diff = last(y) - first(y),
            timediff = last(TIME) - first(TIME)) %>%
  ungroup() %>%
  filter(n >= 2) %>%
  mutate(age  = age - min(age))-> #only keep those ears with at least two measurements
  delta3
delta3 %>% group_by(id, age, age_discrete) %>%
  summarize(n = n(),
            diff = mean(diff),
            timediff = mean(timediff)) %>%
  ungroup() %>%
  filter(n == 2) -> #only keep those id's with a measurement for both ears
  delta2

delta3mod <- lm(diff ~ age + side + timediff, data = delta3)
delta3mod2 <- lm(diff ~ age_discrete + side + timediff, data = delta3)

delta2mod <- lm(diff ~ age + timediff, data = delta2)
delta2mod2 <- lm(diff ~ age_discrete + timediff, data = delta2)
s3 <- summary(delta3mod)
s32 <- summary(delta3mod2)
s2 <- summary(delta2mod)
s22 <- summary(delta2mod2)
options(knitr.kable.NA = '')
data.frame(var = unique(c(rownames(s3$coefficients), 
                                 rownames(s32$coefficients)))) %>%
  left_join(data.frame(var = rownames(s3$coefficients),
                       delta3 = s3$coefficients[,'Estimate'],
                       delta3p = s3$coefficients[,'Pr(>|t|)'])) %>%
  left_join(data.frame(var = rownames(s32$coefficients),
                       delta3_2 = s32$coefficients[,'Estimate'],
                       delta3_2p = s32$coefficients[,'Pr(>|t|)'])) %>%
  left_join(data.frame(var = rownames(s2$coefficients),
                       delta2 = s2$coefficients[,'Estimate'],
                       delta2p = s2$coefficients[,'Pr(>|t|)'])) %>%
  left_join(data.frame(var = rownames(s22$coefficients),
                       delta2_2 = s22$coefficients[,'Estimate'],
                       delta2_2p = s22$coefficients[,'Pr(>|t|)'])) %>%
  mutate(delta3 = str_c(round(delta3,3), stars.pval(delta3p), sep = (" ")),
         delta3_2 = str_c(round(delta3_2,3), stars.pval(delta3_2p), sep = (" ")),
         delta2 = str_c(round(delta2,3), stars.pval(delta2p), sep = (" ")),
         delta2_2 = str_c(round(delta2_2,3), stars.pval(delta2_2p), 
                          sep = (" "))) %>%
  dplyr::select(-delta3p, -delta3_2p, -delta2p, -delta2_2p) %>%
  rbind(c("Rsquared", round(s3$r.squared,3), round(s32$r.squared,3), 
          round(s2$r.squared,3), round(s22$r.squared,3))) %>%
  mutate(var = str_remove(var, "_discrete")) %>%
  kable(caption = "Overview of the regression results for summary statistics",
        col.names = c('Variable', '$\\Delta^{3}_{continuous}$', 
                     '$\\Delta^{3}_{discrete}$', '$\\Delta^{2}_{continuous}$',
                     '$\\Delta^{2}_{discrete}$'),
        escape = FALSE,
        booktabs = TRUE)

```

Next, regression models are made for $\Delta^{2}$ and $\Delta^{3}$. The variables of interest are age at the start of the study (a model with a continuous and discrete version is tested), the side of the ear (can only be tested for $\Delta^{3}$), and the time difference between the first and last measurement (see Table \@ref(tab:Delta2)). The intercept is always negative meaning the first measurement is higher than the last measurement in young subjects. This is unexpected and may be due to the learning effect that has been described in previous literature.
Both age and the time between the first and last measurement have significantly positive coefficients meaning the difference between the first and last measurement is larger and may even become positive for older patients with long time between the first and last measurement. There is no significant difference between the left and right ear.

Table \@ref(tab:Delta4) shows the results for two regression models based on the summary statistic of equation \@ref(eq:delta4). The age in this model refers to the age of the subject in the middle of his follow-up time (i.e. $age$ + $\frac{max(TIME)}{2}$). The intercept now represents the expected hearing threshold for the left ear of a subject that is 0 years on (in the continuous age model) or a subject that is in the youngest age category ($<30$ years old). The older the subject, the higher the expected hearing threshold. There is no significant difference between the left and right ear.

```{r Delta4, echo=FALSE, include=TRUE,  warning=FALSE, message=FALSE}
data %>% group_by(id, side, age, age_discrete) %>%
  arrange(id, side, TIME) %>%
  summarize(y = mean(y),
            timediff = last(TIME) - first(TIME),
            meanage = age + timediff/2,
            meanage_discrete = cut(meanage,
                            breaks = c(0,30,50,70,100),
                            labels = c("<30", "30-50", "50-70",">70"))) %>%
  ungroup() -> #only keep those ears with at least two measurements
  delta4

delta4mod <- lm(y ~ meanage + side , data = delta4)
delta4mod2 <- lm(y ~ meanage_discrete + side , data = delta4)
s4 <- summary(delta4mod)
s42 <- summary(delta4mod2)
options(knitr.kable.NA = '')
data.frame(var = unique(c(rownames(s4$coefficients), 
                                 rownames(s42$coefficients)))) %>%
  left_join(data.frame(var = rownames(s4$coefficients),
                       delta4 = s4$coefficients[,'Estimate'],
                       delta4p = s4$coefficients[,'Pr(>|t|)'])) %>%
  left_join(data.frame(var = rownames(s42$coefficients),
                       delta4_2 = s42$coefficients[,'Estimate'],
                       delta4_2p = s42$coefficients[,'Pr(>|t|)'])) %>%
  mutate(delta4 = str_c(round(delta4,3), stars.pval(delta4p), sep = (" ")),
         delta4_2 = str_c(round(delta4_2,3), stars.pval(delta4_2p), 
                          sep = (" "))) %>%
  dplyr::select(-delta4p, -delta4_2p) %>%
  rbind(c("Rsquared", round(s4$r.squared,3), round(s42$r.squared,3))) %>%
  mutate(var = str_remove(str_remove(var, "_discrete"), "mean")) %>%
  kable(caption = "Overview of the regression results for summary statistics",
        col.names = c('Variable', '$\\Delta^{4}_{continuous}$', 
                     '$\\Delta^{4}_{discrete}$'),
        escape = FALSE,
        booktabs = TRUE)


```

Table \@ref(tab:madspy) details the results of the ANCOVA where the variance of the hearing capabilities are modeled respective to patient age and time within the study. In agreement with the previously derived summary statistics, the starting age of the patient as well as their time spent within the study both have an effect on the MAD and SPY statistics. In further agreement with past results the side of the ear remains unimportant when inferring the expected periodic change of subjectsâ€™ hearing capabilities. From these results it can be stated that both age and the time spent within the study have a positive effect on the observed variance of the measured response. As was in the case with previous analyses, these results imply a potentially large shift in hearing capabilities over time. 

```{r madspy, echo=FALSE, include=TRUE,  warning=FALSE, message=FALSE}
library(tseries)
library(car)
data.right=data[data$side=="right",]
data.left=data[data$side=="left",]

#creating the incremental shift for y in the left ear
data.left$y.inc=data.left$y
for(i in unique(data.left$id)){
  data.left$y.inc[data.left$id==i]=data.left$y[data.left$id==i]-data.left$y[data.left$id==i][1]
}

#creating the incremental shift for y in the right ear
data.right$y.inc=data.right$y
for(i in unique(data.right$id)){
  data.right$y.inc[data.right$id==i]=data.right$y[data.right$id==i]-data.right$y[data.right$id==i][1]
}

#Summary statistics for the right ear
right.idsum=data.right%>%
  group_by(id)%>%
  summarise(count=n(),idsd=sd(y),
            idmad=mad(y),
            idfirst=first(y),
            idlast=last(y),
            SPY=(last(y)-first(y))/max(TIME), #steps per year
            StartingAge=min(age),
            duration=max(TIME),
            side=first(side))%>%
  filter(is.na(SPY)==F)

#test for stochastic process right ear
adf=c()
for (i in unique(right.idsum$id)){
  if(nrow(data.right[data.right$id==i,])>4){
    adf=append(adf,adf.test(data.right[data.right$id==i,]$y)[4][[1]])
  }
  else
    adf=append(adf,NaN)
}
right.idsum$adf=adf

#left ear sum stats.
left.idsum=data.left%>%
  group_by(id)%>%
  summarise(count=n(),idsd=sd(y),
            idmad=mad(y),
            idfirst=first(y),
            idlast=last(y),
            SPY=(last(y)-first(y))/max(TIME), #steps per year
            StartingAge=min(age),
            duration=max(TIME),
            side=first(side))%>%
  filter(is.na(SPY)==F)

adf=c()
for (i in unique(left.idsum$id)){
  if(nrow(data.left[data.left$id==i,])>4){
    adf=append(adf,adf.test(data.left[data.left$id==i,]$y)[4][[1]])
  }
  else
    adf=append(adf,NaN)
}
#test for stochastic process left ear
left.idsum$adf=adf


#prob shouldve just run a second group_by() to get this final data set.
both.idsum=rbind(right.idsum,left.idsum)

#ANCOVA MODELS. ANCOVA model to show significance of age+duration, LM to quantify the relation.
Ancova.MAD=Anova(aov(idmad~StartingAge+duration+side,data=both.idsum),type="III")
Ancova.SPY=Anova(aov(SPY~StartingAge+duration+side,data=both.idsum),type="III")
MODEL.MAD=summary(lm(idmad~StartingAge+duration+side,data=both.idsum))
MODEL.SPY=summary(lm(SPY~StartingAge+duration+side,data=both.idsum))

data.frame(Variable = rownames(Ancova.SPY),
           MADancova = sprintf("%s%s(%d)", round(Ancova.MAD$`Sum Sq`, 3),
                               stars.pval(Ancova.MAD$`Pr(>F)`),
                               Ancova.MAD$`Df`),
           MADreg = c(sprintf("%s%s",
                         round(unname(MODEL.MAD$coefficients[,'Estimate']), 3),
                         stars.pval(unname(
                           MODEL.MAD$coefficients[,'Pr(>|t|)']))),""),
           SPYancova = sprintf("%s%s(%d)", round(Ancova.SPY$`Sum Sq`, 3),
                               stars.pval(Ancova.SPY$`Pr(>F)`),
                               Ancova.SPY$`Df`),
           SPYreg = c(sprintf("%s%s",
                         round(unname(MODEL.SPY$coefficients[,'Estimate']), 3),
                         stars.pval(unname(
                           MODEL.SPY$coefficients[,'Pr(>|t|)']))),"")) %>%
  kable(caption = "Overview of the regression results for SPY and MAD summary statistics",
        col.names = c('Variable', 'Ancova Sum Sq.(Df)', 'lm coef',
                      'Ancova Sum Sq.(Df)', 'lm coef'),
        escape = FALSE,
        booktabs = TRUE) %>%
  add_header_above(c(" ", "MAD" = 2, "SPY" = 2))


```

## Multivariate model

We find that the model $Y_{ijk} = age_{ij} + age^2_{ij} + learning_{ijk} + TIME_{ijk}$ performs really well and is congruent with what has been found before in the literature (model 2 in Table \@ref(tab:multivariate-mean)). We further find that the effect of the *side* variable does not significantly influence the hearing threshold. These conclusions hold for a much wider selection of models (we present here only sample of what we tested) or even when we filter the data under different conditions (Removing subjects with less than $n=\{2,4,5,6\}$ observations, looking at only the right/left ear, treating each ear-subject pair as single subject, balancing the data, grouping the subjects in cohorts of $\{1,5,10,15,20\}$ years and creating dummy variables for them).

```{r multivariate-mean, warning=FALSE, echo=FALSE, warning = FALSE, message = FALSE}
mf <- formula(y ~ age+TIME+side+age:TIME+age:side+TIME:side)
gee1 <- geeglm(mf, data = data, id = id, corstr = "independence")
sgee1 <- coef(summary(gee1)) %>% as.data.frame %>%
  mutate(var= rownames(coef(summary(gee1))),
         gee1 = sprintf("%s%s",round(Estimate,3), stars.pval(`Pr(>|W|)`)))
# QIC(gee1)[2]
# mean(sqrt(resid(gee1)^2))
# coef(summary(gee1))

# mf2 <- formula(y ~ age + TIME + I(age^2) + learning)
# gee2 <- geeglm(mf2, data=data, id=id, corstr="independence")
# sgee2 <- coef(summary(gee2)) %>% as.data.frame %>%
#   mutate(var= rownames(coef(summary(gee2))),
#          gee2 = sprintf("%s%s",round(Estimate,3), stars.pval(`Pr(>|W|)`)))
mf2 <- formula(y ~ age*TIME + learning + I(age^2))
gee2 <- geeglm(mf2, data = data, id = id, corstr = "independence")
sgee2 <- coef(summary(gee2)) %>% as.data.frame %>%
  mutate(var = rownames(coef(summary(gee2))),
         gee2 = sprintf("%s%s",round(Estimate,3), stars.pval(`Pr(>|W|)`)))
# QIC(gee2)[2]
# mean(sqrt(resid(gee2)^2))
# coef(summary(gee2))
mf3 <- formula(y ~ age*TIME + I(age^2))
gee3 <- geeglm(mf3, data = data, id = id, corstr = "independence")
sgee3 <- coef(summary(gee3)) %>% as.data.frame %>%
  mutate(var = rownames(coef(summary(gee3))),
         gee3 = sprintf("%s%s",round(Estimate,3), stars.pval(`Pr(>|W|)`)))

# QIC(gee3)[2]
# mean(sqrt(resid(gee3)^2))
# coef(summary(gee3))

mf4 <- formula(y ~ age+TIME)
gee4 <- geeglm(mf4, data = data, id = id, corstr = "independence")
sgee4 <- coef(summary(gee4)) %>% as.data.frame %>%
  mutate(var = rownames(coef(summary(gee4))),
         gee4 = sprintf("%s%s",round(Estimate,3), stars.pval(`Pr(>|W|)`)))

# QIC(gee4)[2]
# mean(sqrt(resid(gee4)^2))
# coef(summary(gee4))

mf5 <- formula(y ~ age)
gee5 <- geeglm(mf5, data = data, id = id, corstr = "independence")
sgee5 <- coef(summary(gee5)) %>% as.data.frame %>%
  mutate(var = rownames(coef(summary(gee5))),
         gee5 = sprintf("%s%s",round(Estimate,3), stars.pval(`Pr(>|W|)`)))

# QIC(gee5)[2]
# mean(sqrt(resid(gee5)^2))
# coef(summary(gee5))
#anova results --> model 2 is the best
# anova(gee1, gee4)
# anova(gee5, gee4)
# anova(gee2, gee3)
# anova(gee4, gee3)
# anova(gee4, gee5)
data.frame(
  var = unique(c(sgee2$var, sgee1$var))) %>%
  left_join(sgee1[,c('var','gee1')]) %>%
  left_join(sgee2[,c('var','gee2')]) %>%
  left_join(sgee3[,c('var','gee3')]) %>%
  left_join(sgee4[,c('var','gee4')]) %>%
  left_join(sgee5[,c('var','gee5')]) %>%
  rbind(c('QICu', round(QIC(gee1)[2],2), round(QIC(gee2)[2],2), 
          round(QIC(gee3)[2],2), round(QIC(gee4)[2],2), round(QIC(gee5)[2],2))) %>%
  rbind(c("RMSE", round(mean(sqrt(resid(gee1)^2)),2), round(mean(sqrt(resid(gee1)^2)),2),
        round(mean(sqrt(resid(gee3)^2)),2),round(mean(sqrt(resid(gee4)^2)),2),
        round(mean(sqrt(resid(gee5)^2)),2))) %>%
  kable(booktabs = TRUE,
        caption = "Comparison of multivariate models",
        col.names = c("", "model1", "model2", "model3", "model4", "model5")) %>%
  kableExtra::row_spec(9, hline_after = TRUE) %>%
  kableExtra::row_spec(10, hline_after = TRUE)
```

Now we will take a look at different covariance structures for the model (Table \@ref(tab:multivariate-mean). Certain structures may lead to a stronger model fit, whereas others are inappropriate given the nature of our data. We will compare the same model mean structure i.e. $Y_{ijk} = age_{ij} + age^2_{ij} + learning_{ijk} + TIME_{ijk}$ under different covariance structures and evaluate them according to Quasi Information Criterion (`QIC`) value. This is a performance metric which details the relative performance between a set of models. 

```{r multivariate-var, warning=FALSE, echo=FALSE, warning = FALSE, message = FALSE}
mf <- formula(y ~ age*TIME + learning + I(age^2))
gee_opt1 <- geeglm(mf, data=data, id = id, corstr="independence")
# QIC(gee_opt1)
# mean(sqrt(resid(gee_opt1)^2))
gee_opt2 <- geeglm(mf, data=data, id=id, corstr="exchangeable")
# QIC(gee_opt2)
# mean(sqrt(resid(gee_opt2)^2))
#gee_opt3 <- geeglm(mf, data=df, id=id, corstr="unstructured")
#QIC(gee_opt3)

data.frame(var = c("QIC","RMSE"),
           Independent = c(round(unname(QIC(gee_opt1)[1],3)), 
                           round(mean(sqrt(resid(gee_opt1)^2)),2)),
           CompoundSymm = c(round(unname(QIC(gee_opt2)[1],3)), 
                           round(mean(sqrt(resid(gee_opt2)^2)),2))) %>%
  kable(booktabs = TRUE,
        caption = "Comparison of multivariate models with an independent variance structure and a compound symmetry structure.",
        col.names = c("", "independent /\n simple", "compound \nsymmetry")) 
```

It appears that a simple covariance structure that assumes independence across the variables produces the lowest `QIC` value, nevertheless it behooves us to take a closer look at these two models. First let's consider the model with a covariance structure that assumes independence within subject observations (compound symmetry). 
```{r warning=FALSE, echo=FALSE, warning = FALSE, message = FALSE, results='hide'}
gee_opt1_new <- gee(mf, data=data, id = id, family = gaussian, corstr="exchangeable")
gee_opt2_new <- gee(mf, data=data, id = id, family = gaussian, corstr="independence")

```
```{r multivariate-var2, warning=FALSE, echo=FALSE, warning = FALSE, message = FALSE}
summary(gee_opt1_new)$coefficients %>%
  kable(booktabs = TRUE,
         caption = "results for the model with compound symmetry")
```


In the Table \@ref(tab:multivariate-var2), the model with compound symmetry correlation structure, we notice that we get two standard errors: Naive and Robust. Normally we would want to use the Robust estimates because the variances of coefficient estimates tend to be too small when responses within subjects are correlated [@bilder2014analysis], however in this case there is little difference between the Naive and Robust estimates. This further suggests that the independence assumption of the correlation structure seems realistic [@hothorn2009handbook]. Table \@ref(tab:multivariate-var2indep) shows the best model we could find under the conditions of this task. It has the same parameter estimates as a least squares model with the same mean structure specification, however the robust errors in this model are more accurate, as some of the conditions of the least squares model are not fulfilled (e.g. Normally distributed residuals)
```{r multivariate-var2indep, warning=FALSE, echo=FALSE, warning = FALSE, message = FALSE}
summary(gee_opt2_new)$coefficients %>%
  kable(booktabs = TRUE,
         caption = "results for the model with independence")
```

## Two-stage analysis

As previous analyses showed that individuals may have a different time effect, the two-stage analysis first fits individual-specific intercept and time effect (slope). As all previous analyses did not uncover a significant effect of the side of the ear, it is no longer considered in this analysis.

The first stage analysis fits the linear model in equation \@ref(eq:firststage); the variable *learning* is 1 if it's the first visit for the subject ($TIME == 0$). Next, the first stage results are used in the second stage (equation \@ref(eq:secondstage)) to relate the estimated subject-specific parameters to age.

\begin{equation}
Y_{ij} = \beta_{1i} + \beta_{2i}TIME_{ij} + \beta_{2i}*learning_{ij} + \varepsilon_{ij} \quad j = 1,....,n_i
(\#eq:firststage)
\end{equation}

\begin{equation}
\left\{
                \begin{array}{ll}
                  \beta_{1i} = \beta_{0} + \beta_{1}age_i + \beta_{2}age^2_i + b_{1i}\\
                  \beta_{2i} = \beta_{3} + \beta_{4}age_i + \beta_{5}age^2_i + b_{2i}
                \end{array}
              \right.
(\#eq:secondstage)
\end{equation}

```{r twostage, echo=FALSE, include=TRUE,  warning=FALSE, message=FALSE}
#tested models
#y ~ 1 + TIME + TIME2 --> age is only significant for the intercept in the second stage
#y ~ 1 + TIME + TIME2 + firsttime --> age is only significant for the intercept in the second stage
#y ~ 1 + TIME + firsttime --> age is a significant predictor for the intercept and time
#y ~ 1 + firsttime --> age is significant for intercept and firsttime
#y ~ 1 + TIME  --> age is significant for intercept and TIME

stage1 <- data %>% 
  mutate(TIME2 = TIME*TIME,
         firsttime = 1*(TIME == 0)) %>%
  group_by(id) %>%
  filter(n_distinct(TIME) > 1) %>%#only keep id with measures on at least 2 time instances
  do(model = lm(y ~ 1 + TIME + learning, data = .)) %>%
  ungroup() %>%
  mutate(intercept = unlist(model$model)$`coefficients.(Intercept)`)
stage1.results <- stage1 %>% dplyr::select(id) %>%
  mutate(intercept = sapply(
    X = 1:nrow(stage1), 
    FUN = function(x){
      unlist(
        stage1[x,"model"]$model)$`coefficients.(Intercept)`}),
    TIME = sapply(
      X = 1:nrow(stage1),
      FUN = function(x){
        unlist(
          stage1[x,"model"]$model)$`coefficients.TIME`}),
    # TIME2 = sapply(
    #   X = 1:nrow(stage1),
    #   FUN = function(x){
    #     unlist(
    #       stage1[x,"model"]$model)$`coefficients.TIME2`}),
    learning = sapply(
      X = 1:nrow(stage1),
      FUN = function(x){
        unlist(
          stage1[x,"model"]$model)$`coefficients.learning`})
    ) %>%
  left_join(data[,c('id', 'age')] %>%
              group_by(id, age) %>%
              slice(1))

#stage2
stage2 <- lapply(
  X = c("intercept", "TIME", "learning"),
  FUN = function(x){
    summary(lm(as.formula(paste(x,"~age + I(age^2)")), data = stage1.results))}
)
data.frame(
  model = c('Intercept', "TIME", "learning"),
  intercept = 
    sapply(X = 1:length(stage2), FUN =
             function(x){
               paste(
                 round(stage2[[x]]$coefficients["(Intercept)","Estimate"],3),
                 " ", 
                 stars.pval(stage2[[x]]$coefficients["(Intercept)","Pr(>|t|)"])
               )
               }),
  age = 
    sapply(X = 1:length(stage2), FUN =
             function(x){
               paste(
                 round(stage2[[x]]$coefficients["age","Estimate"],3),
                 " ", 
                 stars.pval(stage2[[x]]$coefficients["age","Pr(>|t|)"])
               )
               }),
  age2 = 
    sapply(X = 1:length(stage2), FUN =
             function(x){
               paste(
                 round(stage2[[x]]$coefficients["I(age^2)","Estimate"],3),
                 " ", 
                 stars.pval(stage2[[x]]$coefficients["I(age^2)","Pr(>|t|)"])
               )
               })
) %>%
  kable(booktabs = TRUE,
        caption = "Second-stage results",
        col.names = c('model', 'intercept', 'age', 'age^2'))
```

Table \@ref(tab:twostage) shows the results for the second stage. The first row shows estimates for $\beta_0$, $\beta_1$ and $\beta_2$. The estimated hearing threshold on the first visit for a person that is 0 years old is `r round(stage2[[1]]$coefficients["(Intercept)","Estimate"],3)` `r round(stage2[[3]]$coefficients["(Intercept)","Estimate"],3)` =  `r round(stage2[[1]]$coefficients["(Intercept)","Estimate"] + stage2[[3]]$coefficients["(Intercept)","Estimate"],3)`dB and increases exponentially for each life year age$^2$ is highly significant. The expected slope increases with age (`r paste(round(stage2[[2]]$coefficients["age","Estimate"],3), " (p-value of",  round(stage2[[2]]$coefficients["age","Pr(>|t|)"],3), ")")`).

## Random-effects model

Using what we have learned from the previous sections, and after test several models for the mean structure, we end up with the model $Y_{ijk} = age_{ij} + age^2_{ij} + learning_{ijk} + TIME_{ijk}$ with a random slope and random intercept with $id$ and $side$ as grouping variables (although there was no overall population effect of $side$, it appears that some peoples' left ear consistently scores better/worse than their right ear).

```{r mixedfixed, echo=FALSE, include=TRUE,  warning=FALSE, message=FALSE}
mixed <- nlme::lme(y ~ age*TIME + learning + I(age^2), data = data, 
                   random = ~1+TIME|id/side)#simple (no correlations)
s <- summary(mixed)
mixedcomp <- nlme::lme(y ~ age*TIME + learning + I(age^2), data = data, 
                   random = ~1+TIME|id/side,
                   cor = nlme::corCompSymm())
mixed
```

After having selected the mean structure of the model we need to select the appropriate covariance structure. We do so using a number of measures first with the help of our theoretical understanding, then using the AIC/QIC. Theoretical understanding helps us narrow the number of structures we need to test, for example Autoregressive or Toeplitz type structures are automatically excluded due to irregularities in the time intervals between measurements. For models (mixed model) which use the maximum likelihood we use the AIC. Although the AIC is normally used to select the optimal model using the likelihood and penalizing the number of parameters, we use it to select the covariance structure. That is while holding the parameters the same but changing the covariance structure we see a decrease in the AIC only as a result of a higher likelihood. The same is done with the QIC but for models which use the Quasi maximum Likelihood. We observe that in the mixed model a simple covariance structure has better performance (AIC = `r round(AIC(mixed),2)`) than using compound symmetry (AIC = `r round(AIC(mixedcomp),2)`).

We see that the average hearing threshold at the first visit is 5.57+1.04 = 6.6dB for a subject that is 0 years old. The trend in the hearing threshold is dependent on age. For a 20-year old, we expect an increase of -0.24 + 20*0.0123 = 0.006dB per year. For a 50-year old, we expect an increase in the hearing threshold of 0.375dB per year. We further see that there is a large variability in the intercepts (the standard error is 6.79 ). Also intercepts and slopes appear to be correlated -0.183 which leads us to believe that people with better hearing to begin with are more sensitive to hearing loss (or simply have more hearing to lose). The predicted profiles for each subjects' ears can be found in Figure \@ref(fig:mixedfixedprofiles).

```{r mixedfixedprofiles, echo=FALSE, include=TRUE,  warning=FALSE, message=FALSE, fig.cap="Predicted profiles from the final mixed model.", fig.width=6, fig.height=4}
dat_mixed5 <- data.frame(time = data$TIME,
                       pred = fitted(mixed),
                       Subject = data$id,
                       side = data$side) %>%
  left_join(data[,c("age", "id")], by = c("Subject" = "id"))
  
dat_mixed5$Subject <- as.numeric(dat_mixed5$Subject)
#dat_mixed5<-dat_mixed5 %>% filter(side=="right")
ggplot(data = dat_mixed5, aes(x = time, y = pred, color = age, 
                              shape = side, group = interaction(Subject, side))) + 
  theme_classic() +
  geom_line(alpha = 0.5) + geom_point(alpha = 0.5, size = 1)
```

Further we need to check two assumptions of our model, first that the model error terms follow a normal distribution and secondly the betas for subject [i] also follow a normal distribution. As can be seen in the QQ-plots below this is not necessarily the case for our model. Naturally we could improve on this first by removing outliers which have the highest impact. Secondly we could add additional quadratic terms in TIME and a dummy variable for whether they are above the age of 55. Finally, we can implement a compound symmetric covariance structure to the model. All of these measures improve QQ-plots, nevertheless we did not implement them as both the information criterions got worse and we felt the model became too overfitted and more difficult to interpret.


```{r mixedfixedqqplot, echo=FALSE, include=TRUE,  warning=FALSE, message=FALSE}
#assumptions check 
#1. Error terms follow a Normal Distribution
#2. Beta for subject i follows a Normal Distribution
qint<-nlme::ranef(mixed)$id[["(Intercept)"]]
qres<-residuals(mixed)
par(mfrow=c(1,2))
qqnorm(qint,ylab = "Estimated Random Intecepts",main = "Random Intecepts")
qqline(qint)
qqnorm(qres,ylab = "Estimated Residuals",main = "Residuals")
qqline(qres)
```

# Discussion and conclusion

We observe that on average menâ€™s hearing degrades as they get older, especially after 50 years of age. Men increase their hearing threshold  from the age of about 20 years old and the speed of hearing loss increases as the subjects get older. We do not see any difference between the left and right ear.
As was seen in the literature, we also observed a learning effect; subjects' hearing threshold is expected to be about 1dB higher the first time they get their hearing threshold measured.
Further we see that people with very good hearing to begin with are more sensitive to hearing loss as we see a slight negative correlation between random slopes and intercepts (-0.183).

## Further research
We recommend that future experiments be conducted with a few but vital differences. First, we would recommend that each subject is measured at a fixed time interval. Presently the time difference between steps varies between measurements. Having measurements be done at a fixed interval would allow us to implement a wider selection of covariance structure to the models. Presently autoregressive or Toeplitz type covariance structures are not really applicable to the experimental design.

Secondly, we would recommend that there is a minimum number of measurements implemented per subject. As it stands there are subjects which were measured only once which greatly reduces the available methodology. We would recommend a minimum number of 4 (2 times for each ear) measurements per subject, with more measurements naturally being preferable.


Low number of observations could be to some extent be mitigated in an OLS type setting with the addition of a LASSO or RIDGE penalty. This naturally leads to an estimator which although not consistent, has a much smaller variance, which ultimately leads to a better performance. We are unsure if a LASSO or RIDGE regression is compatible with a mixed model type set up, where we calculate a separate LASSO/RIDGE penalty per subject. We hypothesize this type of methodology could also lead to a per subject variable selection in the LASSO case, which could be useful in problems with many independent variables with non-homogenous subjects. Further research is needed.


# Bibliography

