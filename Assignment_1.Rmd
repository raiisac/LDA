---
documentclass: article
fontsize: 12pt
date: "`r Sys.Date()`"
output: 
  bookdown::pdf_document2: 
    toc: false
    latex_engine: xelatex
    includes:
      in_header: preamble.sty
      before_body: titlepage.sty
bibliography: references.bib  
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(haven) # to read SAS files
library(kableExtra)
library(qwraps2)
library(rprojroot)

knitr::opts_chunk$set(echo = TRUE)
```
# Abstract {-}

# Introduction and data exploration
```{r load, include=FALSE, message=FALSE, warning=FALSE}
data <- read_sas(find_root_file("data/hearing500lr.sas7bdat", 
     criterion = has_file("LDA.Rproj"))) %>%
  mutate(side = as.factor(side),
         id = as.factor(id),
         age_measurement = age + TIME,
         age_discrete = cut(age,
                            breaks = c(0,30,50,70,100),
                            labels = c("<30", "30-50", "50-70",">70")))
#data %>%group_by(id) %>%summarize(diff = max(age_start) - min(age_start)) age_start should be the same all the time but there are huge differences. How is this possible?
summary_data_id <- data %>%
  group_by(id) %>%
  summarize(age = min(age),
            followup = max(TIME),
            nb_visits_left = sum(side == "left"),
            nb_visits_right = sum(side == "right"),
            nb_visits = n_distinct(TIME),
            nb_measurements = n(),
            visits_per_year = ifelse(followup == 0,
                                     NA,
                                     nb_visits / followup))
#sum(summary_data_id$nb_visits_left != summary_data_id$nb_visits_right)#there are 112 people who weren't measure an equal amount of times on the left and right side
summary_data_visit <- data %>%
  group_by(id, TIME) %>%
  summarize(age = min(age) + max(TIME),
            left = sum(side == "left") > 0,
            right = sum(side == "right") > 0)
```

This report assesses hearing thresholds for a sample of `r nlevels(data$id)` healthy male volunteers. The subjects were `r round(mean(summary_data_id$age))` years old on average at the start of the study and are followed for an average of `r round(mean(summary_data_id$followup), digits = 2)` years. The hearing threshold is measured, on average, every `r round(1/mean(summary_data_id$visits_per_year, na.rm = T), digits = 2)` years. Table \@ref(tab:demographics) describes the demographics in more detail. Normally, each ear is measured at each visit but this only happened in `r round(100*sum(summary_data_visit$left & summary_data_visit$right) /nrow(summary_data_visit), 2)`% of all visits. The left (right) ear was tested in `r round(100*sum(summary_data_visit$left) /nrow(summary_data_visit), 2)`% (`r round(100*sum(summary_data_visit$right) /nrow(summary_data_visit), 2)`%) of all visits.



Figure \@ref(fig:rawdata) shows the trends in the hearing threshold for all volunteers over time.

```{r demographics, echo=FALSE}
summary_data_id %>% 
  summarize(
    qwraps2::frmt(min(age)), 
    qwraps2::frmt(max(age)),
    qwraps2::frmt(median(age)), 
    qwraps2::mean_sd(age),
    qwraps2::frmt(min(followup)), 
    qwraps2::frmt(max(followup)), 
    qwraps2::frmt(median(followup)),
    qwraps2::mean_sd(followup),
    qwraps2::frmt(min(nb_visits)), 
    qwraps2::frmt(max(nb_visits)), 
    qwraps2::frmt(median(nb_visits)),
    qwraps2::mean_sd(nb_visits)) %>%
  pivot_longer(cols = everything(),
               names_to = "var",
               values_to = "value") %>%
  mutate(var = rep(c("min","max", "median", "mean (sd)"), 3)) %>%
  kable(caption = "Demographics for all respondents",
        col.names = NULL,
        booktabs = TRUE,
        position = "!b") %>%
  pack_rows("Age at the beginning of the study", 1, 4) %>%
  pack_rows("Years of follow-up", 5, 8) %>%
  pack_rows("Number of visits", 9, 12) 
```


```{r rawdata, echo=FALSE, fig.cap="Hearing threshold over time, divided by left and right ear and by age group at the start of the study", fig.height=5}
agedistribution <- data %>%
  group_by(age_discrete) %>%
  summarize(nb = n_distinct(id)) %>%
  ungroup() %>%
  mutate(label = sprintf("%s, (n = %d)", age_discrete, nb))
lbl_age <- agedistribution$label
names(lbl_age) <- agedistribution$age_discrete

data %>% 
  mutate() %>%
  ggplot() +
  geom_line(aes(x = TIME, y = y,  group = id), alpha = 0.3) +
  facet_grid(cols = vars(side),
             rows = vars(age_discrete),
             labeller = labeller(age_discrete = lbl_age)) +
  theme_bw() +
  ylab("Hearing threshold (Db)") 
```


Describe the data, and use graphical techniques to explore the mean structure, the variance structure and the correlation structure. Summarize your conclusions. What are the implications with respect to statistical modeling ?

# Methodology



All analysis was carried out with the statistical software R. All scripts are freely available at [this git repository](https://github.com/raiisac/LDA).

# Results

# Discussion and conclusion

## further research

# Bibliography

