---
documentclass: article
fontsize: 12pt
date: "`r Sys.Date()`"
output: 
  bookdown::pdf_document2: 
    toc: false
    latex_engine: xelatex
    includes:
      in_header: preamble.sty
      before_body: titlepage.sty
bibliography: references.bib  
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(haven) # to read SAS files
library(kableExtra)
library(qwraps2)
library(rprojroot)
library(patchwork)
library(psych)

knitr::opts_chunk$set(echo = TRUE)
```
# Abstract {-}

# Introduction and data exploration
```{r load, include=FALSE, message=FALSE, warning=FALSE}
data <- read_sas(find_root_file("data/hearing500lr.sas7bdat", 
     criterion = has_file("LDA.Rproj"))) %>%
  mutate(side = as.factor(side),
         id = as.factor(id),
         age_measurement = age + TIME,
         age_discrete = cut(age,
                            breaks = c(0,30,50,70,100),
                            labels = c("<30", "30-50", "50-70",">70")))
#data %>%group_by(id) %>%summarize(diff = max(age_start) - min(age_start)) age_start should be the same all the time but there are huge differences. How is this possible?
summary_data_id <- data %>%
  group_by(id) %>%
  summarize(age = min(age),
            followup = max(TIME),
            nb_visits_left = sum(side == "left"),
            nb_visits_right = sum(side == "right"),
            nb_visits = n_distinct(TIME),
            nb_measurements = n(),
            visits_per_year = ifelse(followup == 0,
                                     NA,
                                     nb_visits / followup))
#sum(summary_data_id$nb_visits_left != summary_data_id$nb_visits_right)#there are 112 people who weren't measure an equal amount of times on the left and right side
summary_data_visit <- data %>%
  group_by(id, TIME) %>%
  summarize(age = min(age) + max(TIME),
            left = sum(side == "left") > 0,
            right = sum(side == "right") > 0)

#correlations
d <- data %>%
  mutate(id = as.numeric(id),
         left = 1*(side == "left")) %>%
  dplyr::select(id, y, left, age_measurement)
```

This report assesses hearing thresholds for a sample of `r nlevels(data$id)` healthy male volunteers. The subjects were `r round(mean(summary_data_id$age))` years old on average at the start of the study and are followed for an average of `r round(mean(summary_data_id$followup), digits = 2)` years. The hearing threshold is measured, on average, every `r round(1/mean(summary_data_id$visits_per_year, na.rm = T), digits = 2)` years. Table \@ref(tab:demographics) describes the demographics in more detail. It can be seen that the data is highly unbalanced; there is a lot of variation in the time a volunteer is followed and in the number of times a volunteer visits. 
Normally, each ear is measured at each visit but this only happened in `r round(100*sum(summary_data_visit$left & summary_data_visit$right) /nrow(summary_data_visit), 2)`% of all visits. The left (right) ear was tested in `r round(100*sum(summary_data_visit$left) /nrow(summary_data_visit), 2)`% (`r round(100*sum(summary_data_visit$right) /nrow(summary_data_visit), 2)`%) of all visits.

Previous research on hearing data of the Baltimore Longitudinal Study of Aging (BLSA) showed a change in hearing threshold for all age groups but especially the older population in males [@doi:10.1121/1.399731]. In contrast to our dataset, @doi:10.1121/1.412231 and @morrell1997construction consider females in their study. They similarly found a decrease in hearing sensitivity for all ages at 500Hz and included a quadratic function of age to predict the hearing threshold, as in @verbeke2001conditional. Additionally, a statistically significant learning effect from the first visit to subsequent visits was found [@morrell1997construction; @verbeke2001conditional]. @morrell1997construction observed that hearing levels are slightly poorer on average on the left compared to the right ear and that the variance in the hearing threshold is higher for people with a higher age.


Figures \@ref(fig:rawdata) and \@ref(fig:rawdata2) show the trends in the hearing threshold for all volunteers over time. These figures shows that many volunteers' hearing threshold over time has an erratic pattern meaning there is likely high variability **within subjects**. Additionally, variability between subjects is also high, especially for older volunteers. 


```{r demographics, echo=FALSE}
summary_data_id %>% 
  summarize(
    qwraps2::frmt(min(age)), 
    qwraps2::frmt(max(age)),
    qwraps2::frmt(median(age)), 
    qwraps2::mean_sd(age),
    qwraps2::frmt(min(followup)), 
    qwraps2::frmt(max(followup)), 
    qwraps2::frmt(median(followup)),
    qwraps2::mean_sd(followup),
    qwraps2::frmt(min(nb_visits)), 
    qwraps2::frmt(max(nb_visits)), 
    qwraps2::frmt(median(nb_visits)),
    qwraps2::mean_sd(nb_visits)) %>%
  pivot_longer(cols = everything(),
               names_to = "var",
               values_to = "value") %>%
  mutate(var = rep(c("min","max", "median", "mean (sd)"), 3)) %>%
  kable(caption = "Demographics for all respondents",
        col.names = NULL,
        booktabs = TRUE,
        position = "!b") %>%
  pack_rows("Age at the beginning of the study", 1, 4) %>%
  pack_rows("Years of follow-up", 5, 8) %>%
  pack_rows("Number of visits", 9, 12)
```


```{r rawdata, echo=FALSE, fig.cap="Hearing threshold over time, divided by left and right ear and by age group at the start of the study", fig.height=5}
agedistribution <- data %>%
  group_by(age_discrete) %>%
  summarize(nb = n_distinct(id)) %>%
  ungroup() %>%
  mutate(label = sprintf("%s, (n = %d)", age_discrete, nb))
lbl_age <- agedistribution$label
names(lbl_age) <- agedistribution$age_discrete

data %>% 
  mutate() %>%
  ggplot() +
  geom_line(aes(x = TIME, y = y,  group = id), alpha = 0.3) +
  facet_grid(cols = vars(side),
             rows = vars(age_discrete),
             labeller = labeller(age_discrete = lbl_age)) +
  theme_bw() +
  ylab("Hearing threshold (Db)") 
```

```{r rawdata2, echo=FALSE, fig.cap= "Hearing threshold over time, divided by left and right ear.", fig.height=5}
eardistribution <- data %>%
  group_by(side) %>%
  summarize(nb = n_distinct(id)) %>%
  ungroup() %>%
  mutate(label = sprintf("%s, (n = %d)", side, nb))
lbl_side <- eardistribution$label
names(lbl_side) <- eardistribution$side

data %>% 
  mutate() %>%
  ggplot() +
  geom_line(aes(x = age_measurement, y = y,  group = id), alpha = 0.3) +
  facet_grid(rows = vars(side),
             labeller = labeller(side = lbl_side)) +
  theme_bw() +
  ylab("Hearing threshold (Db)") +
  xlab("Age at the time of the measurement")
```

## Mean, variance and correlation structure

Figure \@ref(fig:rawdata3) shows the mean and 95% confidence interval for the hearing threshold (dB) for different age group. The age is the age at the time the measurement was taken. While the top graph shows 15 age groups with approximately equal sample size (between 141 and 149 measurements in each group), the bottom graph shows age groups with the same interval range of about 5 years. Both graphs show that the variance increases with age and there doesn't seem to be a significant difference, on average, between left and right ears.

```{r rawdata3, echo=FALSE, message = FALSE, fig.cap= "Hearing threshold over time, divided by left and right ear. numbers in the bottom show the number of measurements that were taken.", fig.width = 5, fig.height=8}
#same number of measurements 
agediscrete <- data %>% 
  mutate(
    #age = cut(data$age_measurement, n = 15)
    age = cut_number(data$age_measurement, n = 15)) %>%
  group_by(side, age) %>%
  summarize(mean = mean(y),
            sd = sqrt(var(y)),
            n = n()) %>%
  ungroup() %>%
  mutate(error = qnorm(0.975)*sd/sqrt(n))#95percent conf intervals
  
p <- agediscrete %>% 
  ggplot() +
  geom_pointrange(aes(x = age, y = mean, color = side, group = side, 
                    ymin = mean - error, ymax = mean + error), 
                  position = position_dodge(width = 0.5), alpha = 1) +
  geom_text(aes(x = age, y = 0, label = n, color = side),
            position = position_dodge(width = 1), size = 2) +
  theme_bw() +
  ylab("Hearing threshold (Db), mean and 95% CI") +
  xlab("Age at the time of the measurement") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

#same range intervals
agediscrete <- data %>% 
  mutate(
    age = cut_interval(data$age_measurement, n = 15)) %>%
    #age = cut_number(data$age_measurement, n = 15)) %>%
  group_by(side, age) %>%
  summarize(mean = mean(y),
            sd = sqrt(var(y)),
            n = n()) %>%
  ungroup() %>%
  mutate(error = qnorm(0.975)*sd/sqrt(n))#95percent conf intervals
  
q <- agediscrete %>% 
  ggplot() +
  geom_pointrange(aes(x = age, y = mean, color = side, group = side, 
                    ymin = mean - error, ymax = mean + error), 
                  position = position_dodge(width = 0.5), alpha = 1) +
  geom_text(aes(x = age, y = 0, label = n, color = side),
            position = position_dodge(width = 1), size = 2) +
  theme_bw() +
  ylab("Hearing threshold (Db), mean and 95% CI") +
  xlab("Age at the time of the measurement") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
plot <- p / q & theme(legend.position = "bottom") 
plot + plot_layout(guides = "collect")

```


```{r , echo=FALSE, include=TRUE,  warning=FALSE, message=FALSE}
stats <- statsBy(d, group = c("id", "left"), cors = FALSE, cor = "cov", 
        method = "pearson", use = "pairwise", poly = FALSE,
        na.rm = TRUE, alpha = .05)
morethan1 <- d %>% group_by(id, left) %>% summarize(n = n()) %>% ungroup() %>%
  group_by(id) %>%summarize(n=min(n)) %>%
  right_join(d) %>% filter(n > 1) %>% dplyr::select(-n)#only keep id's that have more than 1 measurement both on left and right ear
stats_gt1 <- statsBy(morethan1, group = c("id", "left"), cors = TRUE, cor = "cov", 
        method = "pearson", use = "pairwise", poly = FALSE,
        na.rm = TRUE, alpha = .05)
#pull the correlations between y and age within each group
cov_within <- sapply(X = 1:length(stats_gt1$r), 
                     FUN = function(x) unlist(stats_gt1$r[x])[2])
var_y <- sapply(X = 1:length(stats_gt1$r), 
                FUN = function(x) unlist(stats_gt1$r[x])[1])
var_age <- sapply(X = 1:length(stats_gt1$r), 
                FUN = function(x) unlist(stats_gt1$r[x])[4])
correlations_within <- data.frame(cov_within = cov_within,
                                  var_y = var_y,
                                  var_age = var_age) %>%
  mutate(cor_within = cov_within / (sqrt(var_y)*sqrt(var_age)))
#print(stats, short = FALSE)
meanstructure <- data.frame(stats_gt1$mean)
```
It is obviuous that the data has a hierarchical structure where the highest hierarchical level is the level of the individual ($id$) and the second level is the side (left or right ear). Some basic descriptive statistics were derived using the [*statsBy*](https://www.rdocumentation.org/packages/psych/versions/2.2.9/topics/statsBy) function from the psych package. The intraclass correlation is `r unname(round(stats_gt1$ICC1['y'],2))` for the hearing threshold ($y$) and, as expected, very high (`r unname(round(stats_gt1$ICC1['age_measurement'],2))`) for age at the time of measurement. These high values reflect that the total variance in these variables that is associated with the groups is very high.

The total correlation between y and the age at the measurement, ignoring the hierarchical structure, is `r round(cor(morethan1)['age_measurement','y'],2)`. Following @marzban2013within and @mongomery2017montgomery, the correlation matrix for each subject that has at least 2 measurements for both ears is calculated, one can obtain within-group correlations and variances (where a group is a unique combination of subject and side). Figure \@ref(fig:correlations) shows the histograms over all groups for the correlation between the age at the measurement and y, and the variances for both age and y (though the variance in age is not very informative). The mean or median of all within-group correlations is often used as a measure of within-group correlation. The mean (`r round(mean(correlations_within$cor_within, na.rm = TRUE),2)`) and median (`r round(median(correlations_within$cor_within, na.rm = TRUE),2)`) of the within-group correlations are indicated in red and blue respectively on the graph. It can we seen that within-group correlation spans the entire range from -1 to 1, meaning that age has a strong positive relationship to the hearing threshold for some and a strong negative relationship for others. Age will be a good predictor for hearing threshold for some but not for others. Between-group correlation is obtained by averaging the age at measurement and the hearing threshold for each group (see scatterplot in Figure \@ref(fig:correlations)) and then computing the correlation across the groups, obtaining `r round(cor(meanstructure)['age_measurement','y'],2)`. 

```{r correlations, echo=FALSE, include=TRUE,  warning=FALSE, message=FALSE, fig.cap="The mean is indicated in red, the median in blue", fig.width = 6, fig.height=6}
p1 <- ggplot() + geom_histogram(data = correlations_within, aes(x = cor_within)) + 
  theme_bw() + xlab('Within-group correlation between y & age') +
  ylab('Number of groups') +
  geom_vline(aes(xintercept = mean(correlations_within$cor_within, na.rm = TRUE)), color = 'red') +
  geom_vline(aes(xintercept = median(correlations_within$cor_within, na.rm = TRUE)), color = 'blue') 
p2 <- ggplot(correlations_within) + geom_histogram(aes(x = var_y)) + 
  theme_bw() + xlab("Variance in y") + ylab('Number of groups') + 
  geom_vline(aes(xintercept = mean(correlations_within$var_y, na.rm = TRUE)), color = 'red') +
  geom_vline(aes(xintercept = median(correlations_within$var_y, na.rm = TRUE)), color = 'blue') 
p3 <- ggplot(correlations_within) + geom_histogram(aes(x = var_age)) + 
  theme_bw() + xlab("Variance in age at the measurement") +
  ylab('Number of groups')+ 
  geom_vline(aes(xintercept = mean(correlations_within$var_age, na.rm = TRUE)), color = 'red') +
  geom_vline(aes(xintercept = median(correlations_within$var_age, na.rm = TRUE)), color = 'blue') 
p4 <- ggplot(meanstructure) + geom_point(aes(y = y, x = age_measurement)) +
  xlab("mean age") + ylab("mean hearing threshold (dB)") + theme_bw() 
  
p1 + p2 + p3 + p4
```

Describe the data, and use graphical techniques to explore the mean structure, the variance structure and the correlation structure. Summarize your conclusions. What are the implications with respect to statistical modeling ?

# Methodology

In this section, we explore a couple of different methods to analyze the data. 
All analysis was carried out with the statistical software R. All scripts are freely available at [this git repository](https://github.com/raiisac/LDA).

## Summary statistics

One possibility to deal with the hierarchical structure of the data is to summarize the data and reduce the number of measurements per subject to one.

This can be done, for instance, by calculating the average change in the hearing threshold for each subject $i$, $\Delta_i$ as in equation \@ref(eq:delta) where $Y_{ijk}$ is the $k^{th}$ measurement for ear $j$ of subject $i$ and $n_{ij}$ is the total number of measurements of ear $j$ of subject $i$.
\begin{equation}
\Delta_i = \frac{(Y_{il1} - Y_{iln_{ij}}) + (Y_{ir1} - Y_{irn_{ij}})}{2}
(\#eq:delta)
\end{equation}

An immediate problem with this method is that we have learned the the within-group variance in the hearing threshold is quite large. Focusing only on the first and last measurement is therefore risky. Additionally, if time would influence hearing threshold, we need to correct for the time between the first and last measurement since this differs a lot between subjects. This method also requires that each subjects' both ears have been measured at least twice.

An even simpler summary statistic would be to use the average hearing threshold over all measurements and both ears. This would, however, not allow us to analyse changes in individuals over time; we can only infer on the population effect between age an hearing threshold. 


## Multivariate model

## Two-stage analysis

## Random-effects model

# Results

## Summary statistics



## Multivariate model

## Two-stage analysis

## Random-effects model

# Discussion and conclusion

## further research

# Bibliography

